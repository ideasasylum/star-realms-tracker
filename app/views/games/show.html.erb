<div class="starfield"></div>
<div class="container">
  <div class="header">
    <h1>Game Details</h1>
    <div class="header-actions">
      <%= link_to "All Games", games_path, class: "btn btn-secondary" %>
      <%= link_to "Analyse New Game", new_game_path, class: "btn btn-primary" %>
    </div>
  </div>

  <div class="results">
    <div class="summary">
      <div class="stat-row">
        <span class="label">Players</span>
        <span class="value"><%= @game.players_by_result.join(" vs ") %></span>
      </div>
      <div class="stat-row">
        <span class="label">Final Score</span>
        <span class="value"><%= @game.final_score_by_result %></span>
      </div>
      <div class="stat-row">
        <span class="label">Winner</span>
        <% if @result.winner %>
          <span class="value winner"><%= @result.winner %></span>
        <% else %>
          <span class="value incomplete">Incomplete</span>
        <% end %>
      </div>
      <div class="stat-row">
        <span class="label">Total Turns</span>
        <span class="value"><%= @result.total_turns %></span>
      </div>
      <% if @result.mission_game? %>
        <div class="stat-row">
          <span class="label">Game Mode</span>
          <span class="value mission-mode">Missions</span>
        </div>
        <% @result.players.each do |player| %>
          <% missions = @result.missions_by_turn[player] %>
          <% if missions.any? %>
            <div class="stat-row">
              <span class="label"><%= player %> Missions</span>
              <span class="value">
                <%= missions.map { |turn, name| "#{name} (Turn #{turn})" }.join(", ") %>
                <span class="mission-count">(<%= missions.size %>/3)</span>
              </span>
            </div>
          <% end %>
        <% end %>
      <% end %>
      <div class="stat-row meta">
        <span class="label">Recorded</span>
        <span class="value"><%= @game.created_at.strftime("%B %d, %Y at %I:%M %p") %></span>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="authorityChart"></canvas>
    </div>

    <div class="chart-container">
      <canvas id="deckSizeChart"></canvas>
    </div>

    <div class="deck-composition">
      <h2>Final Deck Composition</h2>
      <div class="deck-grid">
        <% @result.players.each do |player| %>
          <% deck = @result.final_deck(player) %>
          <% if deck %>
            <div class="player-deck">
              <div class="player-name"><%= player %></div>
              <div class="deck-total"><%= @result.final_deck_size(player) %> cards</div>
              <div class="faction-bars">
                <% total = @result.final_deck_size(player).to_f %>
                <% if deck[:trade_federation] > 0 %>
                  <div class="faction-bar trade-federation" style="width: <%= (deck[:trade_federation] / total * 100).round(1) %>%" title="Trade Federation: <%= deck[:trade_federation] %>">
                    <span class="faction-count"><%= deck[:trade_federation] %></span>
                  </div>
                <% end %>
                <% if deck[:blob] > 0 %>
                  <div class="faction-bar blob" style="width: <%= (deck[:blob] / total * 100).round(1) %>%" title="Blob: <%= deck[:blob] %>">
                    <span class="faction-count"><%= deck[:blob] %></span>
                  </div>
                <% end %>
                <% if deck[:star_empire] > 0 %>
                  <div class="faction-bar star-empire" style="width: <%= (deck[:star_empire] / total * 100).round(1) %>%" title="Star Empire: <%= deck[:star_empire] %>">
                    <span class="faction-count"><%= deck[:star_empire] %></span>
                  </div>
                <% end %>
                <% if deck[:machine_cult] > 0 %>
                  <div class="faction-bar machine-cult" style="width: <%= (deck[:machine_cult] / total * 100).round(1) %>%" title="Machine Cult: <%= deck[:machine_cult] %>">
                    <span class="faction-count"><%= deck[:machine_cult] %></span>
                  </div>
                <% end %>
                <% if deck[:neutral] > 0 %>
                  <div class="faction-bar neutral" style="width: <%= (deck[:neutral] / total * 100).round(1) %>%" title="Neutral: <%= deck[:neutral] %>">
                    <span class="faction-count"><%= deck[:neutral] %></span>
                  </div>
                <% end %>
              </div>
              <div class="faction-legend">
                <% if deck[:trade_federation] > 0 %><span class="legend-item trade-federation">TF</span><% end %>
                <% if deck[:blob] > 0 %><span class="legend-item blob">Blob</span><% end %>
                <% if deck[:star_empire] > 0 %><span class="legend-item star-empire">SE</span><% end %>
                <% if deck[:machine_cult] > 0 %><span class="legend-item machine-cult">MC</span><% end %>
                <% if deck[:neutral] > 0 %><span class="legend-item neutral">N</span><% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%= content_tag :script, nil,
          type: "module",
          data: {
            chart_data: @result.authority_by_turn.to_json,
            players: @result.players.to_json,
            missions: @result.missions_by_turn.to_json,
            deck_size: @result.deck_size_by_turn.to_json
          },
          id: "chart-data" %>

    <div class="danger-zone">
      <%= button_to "Delete Game", game_path(@game), method: :delete, class: "btn btn-danger", data: { turbo_confirm: "Are you sure you want to delete this game?" } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
  function initCharts() {
    const dataEl = document.getElementById("chart-data");
    if (dataEl && !dataEl.dataset.chartInitialized) {
      dataEl.dataset.chartInitialized = "true";
      const chartData = JSON.parse(dataEl.dataset.chartData);
      const players = JSON.parse(dataEl.dataset.players);
      const missions = JSON.parse(dataEl.dataset.missions);
      const deckSizeData = JSON.parse(dataEl.dataset.deckSize);

      // Neon colors for space theme
      const colors = ["#00d4ff", "#ff4444"];

      // Create a yellow star image for mission markers
      const starSize = 28;
      const starImage = new Image(starSize, starSize);
      const starSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${starSize}" height="${starSize}" viewBox="0 0 24 24">
          <path fill="#FFD700" stroke="#FFA500" stroke-width="1"
            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>`;
      starImage.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(starSvg);

      // Calculate min authority across all players for y-axis
      let minAuthority = 0;
      players.forEach(player => {
        const playerData = chartData[player];
        playerData.forEach(([turn, authority]) => {
          if (authority < minAuthority) minAuthority = authority;
        });
      });

      // Build datasets for each player
      const datasets = players.map((player, index) => {
        const playerData = chartData[player];
        return {
          label: player,
          data: playerData.map(([turn, authority]) => ({ x: turn, y: authority })),
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length] + "20",
          fill: false,
          tension: 0.1,
          borderWidth: 2,
          pointBackgroundColor: colors[index % colors.length],
          pointBorderColor: colors[index % colors.length],
          pointRadius: 4,
          pointHoverRadius: 6
        };
      });

      // Build mission marker datasets (yellow stars on correct points, rendered on top)
      players.forEach((player, index) => {
        const playerMissions = missions[player] || [];
        if (playerMissions.length > 0) {
          // Find authority at each mission turn
          const playerData = chartData[player];
          const missionPoints = playerMissions.map(([turn, missionName]) => {
            // Find the authority at this turn (or closest prior)
            const authorityAtTurn = playerData.find(([t, a]) => t === turn);
            const authority = authorityAtTurn ? authorityAtTurn[1] : 50;
            return { x: turn, y: authority, mission: missionName };
          });

          datasets.push({
            label: `${player} Missions`,
            data: missionPoints,
            pointStyle: starImage,
            pointRadius: starSize / 2,
            pointHoverRadius: starSize / 2 + 4,
            showLine: false,
            type: "scatter",
            order: -1 // Render on top of other datasets
          });
        }
      });

      const ctx = document.getElementById("authorityChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "Authority Over Time",
              color: "#e0e0e0",
              font: { size: 16, weight: "normal" }
            },
            legend: {
              position: "top",
              labels: {
                color: "#e0e0e0",
                filter: function(item, chart) {
                  return !item.text.includes("Missions");
                }
              }
            },
            tooltip: {
              backgroundColor: "rgba(20, 20, 35, 0.9)",
              titleColor: "#fff",
              bodyColor: "#e0e0e0",
              borderColor: "rgba(0, 212, 255, 0.5)",
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  if (context.raw.mission) {
                    return `${context.dataset.label.replace(" Missions", "")}: ${context.raw.mission} completed`;
                  }
                  return `${context.dataset.label}: ${context.raw.y} Authority`;
                }
              }
            }
          },
          scales: {
            x: {
              type: "linear",
              title: {
                display: true,
                text: "Turn",
                color: "#888"
              },
              ticks: {
                stepSize: 1,
                color: "#888"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              }
            },
            y: {
              title: {
                display: true,
                text: "Authority",
                color: "#888"
              },
              ticks: {
                color: "#888"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              },
              min: minAuthority
            }
          }
        }
      });

      // Deck Size Chart
      const deckDatasets = players.map((player, index) => {
        const playerData = deckSizeData[player];
        return {
          label: player,
          data: playerData.map(([turn, size]) => ({ x: turn, y: size })),
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length] + "20",
          fill: false,
          tension: 0.1,
          borderWidth: 2,
          pointBackgroundColor: colors[index % colors.length],
          pointBorderColor: colors[index % colors.length],
          pointRadius: 4,
          pointHoverRadius: 6
        };
      });

      const deckCtx = document.getElementById("deckSizeChart").getContext("2d");
      new Chart(deckCtx, {
        type: "line",
        data: { datasets: deckDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "Deck Size Over Time",
              color: "#e0e0e0",
              font: { size: 16, weight: "normal" }
            },
            legend: {
              position: "top",
              labels: {
                color: "#e0e0e0"
              }
            },
            tooltip: {
              backgroundColor: "rgba(20, 20, 35, 0.9)",
              titleColor: "#fff",
              bodyColor: "#e0e0e0",
              borderColor: "rgba(0, 212, 255, 0.5)",
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw.y} cards`;
                }
              }
            }
          },
          scales: {
            x: {
              type: "linear",
              title: {
                display: true,
                text: "Turn",
                color: "#888"
              },
              ticks: {
                stepSize: 1,
                color: "#888"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              }
            },
            y: {
              title: {
                display: true,
                text: "Cards",
                color: "#888"
              },
              ticks: {
                color: "#888"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              },
              min: 0
            }
          }
        }
      });
    }
  }

  // Handle both initial page load and Turbo navigation
  document.addEventListener("DOMContentLoaded", initCharts);
  document.addEventListener("turbo:load", initCharts);
</script>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: #0a0a0f;
    min-height: 100vh;
  }

  .starfield {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background:
      radial-gradient(ellipse at bottom, #1a1a2e 0%, #0a0a0f 100%);
    z-index: -1;
  }

  .starfield::before,
  .starfield::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
      radial-gradient(2px 2px at 20px 30px, #fff, transparent),
      radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
      radial-gradient(1px 1px at 90px 40px, #fff, transparent),
      radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
      radial-gradient(1px 1px at 230px 80px, #fff, transparent),
      radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent),
      radial-gradient(1px 1px at 370px 50px, #fff, transparent),
      radial-gradient(2px 2px at 450px 180px, rgba(255,255,255,0.8), transparent),
      radial-gradient(1px 1px at 520px 90px, #fff, transparent),
      radial-gradient(2px 2px at 600px 200px, rgba(255,255,255,0.9), transparent);
    background-size: 650px 250px;
    animation: twinkle 8s ease-in-out infinite;
  }

  .starfield::after {
    background-size: 750px 300px;
    animation-delay: -4s;
    opacity: 0.7;
  }

  @keyframes twinkle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    color: #e0e0e0;
    position: relative;
    z-index: 1;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
  }

  h1 {
    margin: 0;
    color: #fff;
    font-weight: 300;
    font-size: 2rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    text-shadow: 0 0 20px rgba(0, 200, 255, 0.5), 0 0 40px rgba(0, 200, 255, 0.2);
  }

  .btn {
    padding: 0.75rem 1.5rem;
    background: transparent;
    color: #fff;
    border: 2px solid;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.3s ease;
  }

  .btn-primary {
    border-color: #00d4ff;
    color: #00d4ff;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.3), inset 0 0 10px rgba(0, 212, 255, 0.1);
  }

  .btn-primary:hover {
    background: rgba(0, 212, 255, 0.2);
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.5), inset 0 0 20px rgba(0, 212, 255, 0.2);
  }

  .btn-secondary {
    border-color: #888;
    color: #aaa;
  }

  .btn-secondary:hover {
    border-color: #aaa;
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
  }

  .results {
    padding-top: 1rem;
  }

  .summary {
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: rgba(20, 20, 35, 0.8);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 8px;
    backdrop-filter: blur(10px);
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-row:last-child {
    border-bottom: none;
  }

  .stat-row .label {
    color: #888;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
  }

  .stat-row .value {
    color: #e0e0e0;
    font-weight: 500;
  }

  .stat-row .value.winner {
    color: #4ade80;
    text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
  }

  .stat-row .value.incomplete {
    color: #888;
    font-style: italic;
  }

  .stat-row .value.mission-mode {
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  }

  .stat-row .mission-count {
    color: #ffd700;
  }

  .stat-row.meta {
    margin-top: 0.5rem;
    padding-top: 1rem;
  }

  .stat-row.meta .value {
    color: #666;
    font-size: 0.875rem;
  }

  .chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 1.5rem;
    background: rgba(20, 20, 35, 0.8);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 8px;
    padding: 1rem;
    backdrop-filter: blur(10px);
  }

  .deck-composition {
    padding: 1.5rem;
    background: rgba(20, 20, 35, 0.8);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 8px;
    backdrop-filter: blur(10px);
  }

  .deck-composition h2 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 400;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .deck-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .player-deck {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .player-name {
    font-weight: 500;
    color: #e0e0e0;
  }

  .deck-total {
    font-size: 0.85rem;
    color: #888;
  }

  .faction-bars {
    display: flex;
    height: 24px;
    border-radius: 4px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.05);
  }

  .faction-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    transition: all 0.2s ease;
  }

  .faction-bar:hover {
    filter: brightness(1.2);
  }

  .faction-count {
    font-size: 0.75rem;
    font-weight: 600;
    color: #000;
    text-shadow: 0 0 2px rgba(255, 255, 255, 0.5);
  }

  .faction-bar.trade-federation {
    background: #1589FF;
  }

  .faction-bar.blob {
    background: #4CC417;
  }

  .faction-bar.star-empire {
    background: #FFFF00;
  }

  .faction-bar.machine-cult {
    background: #FF0000;
  }

  .faction-bar.neutral {
    background: #800080;
    color: #fff;
  }

  .faction-bar.neutral .faction-count {
    color: #fff;
  }

  .faction-legend {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .legend-item {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-weight: 500;
  }

  .legend-item.trade-federation {
    background: rgba(21, 137, 255, 0.3);
    color: #1589FF;
  }

  .legend-item.blob {
    background: rgba(76, 196, 23, 0.3);
    color: #4CC417;
  }

  .legend-item.star-empire {
    background: rgba(255, 255, 0, 0.3);
    color: #FFFF00;
  }

  .legend-item.machine-cult {
    background: rgba(255, 0, 0, 0.3);
    color: #FF0000;
  }

  .legend-item.neutral {
    background: rgba(128, 0, 128, 0.3);
    color: #b080b0;
  }

  .danger-zone {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255, 68, 68, 0.3);
    text-align: right;
  }

  .btn-danger {
    border-color: #ff4444;
    color: #ff4444;
    background: transparent;
    box-shadow: none;
  }

  .btn-danger:hover {
    background: rgba(255, 68, 68, 0.2);
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }

    .header {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      text-align: center;
    }

    .header-actions {
      flex-direction: column;
      gap: 0.5rem;
    }

    .btn {
      width: 100%;
      text-align: center;
      padding: 1rem;
    }

    .summary {
      padding: 1rem;
    }

    .stat-row {
      flex-direction: column;
      gap: 0.25rem;
      padding: 0.75rem 0;
    }

    .stat-row .label {
      font-size: 0.7rem;
    }

    .stat-row .value {
      font-size: 0.95rem;
    }

    .chart-container {
      height: 300px;
      padding: 0.5rem;
    }

    .deck-composition {
      padding: 1rem;
    }

    .deck-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }

  @media (max-width: 480px) {
    h1 {
      font-size: 1.25rem;
      letter-spacing: 0.05em;
    }

    .chart-container {
      height: 250px;
    }
  }
</style>
